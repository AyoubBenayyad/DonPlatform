<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: main(~{::content})}">

<body>
    <div th:fragment="content">
        <div class="fade-in-up" style="max-width: 900px; margin: 0 auto;">

            <!-- User Info Section -->
            <div class="card glass-effect mb-4">
                <div style="display: flex; gap: 2rem; align-items: center;">
                    <div
                        style="width: 100px; height: 100px; background: var(--bg-gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem;">
                        ðŸ‘¤
                    </div>
                    <div style="flex: 1;">
                        <h2 id="profile-username" class="text-gradient" style="margin-bottom: 0.5rem;">Utilisateur</h2>
                        <p id="profile-email" style="color: var(--text-muted); margin-bottom: 0.5rem;">email@example.com
                        </p>
                        <p style="font-size: 0.9rem;">Membre depuis : <span id="profile-date"
                                style="font-weight: 600;">-</span></p>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div style="margin-bottom: 2rem; border-bottom: 2px solid #eee;">
                <button class="btn btn-outline"
                    style="border:none; border-bottom: 3px solid var(--primary-color); border-radius: 0;">Mes
                    Annonces</button>
                <div style="float: right;">
                    <a href="/annonces/new" class="btn btn-primary btn-sm">
                        <img src="/images/icons/plus.svg" width="16" height="16"
                            style="filter: invert(1); vertical-align: middle;" /> Nouvelle Annonce
                    </a>
                </div>
            </div>

            <!-- My Announcements List -->
            <div id="my-annonces-list" class="grid">
                <div class="loader-container">
                    <div class="loader"></div>
                </div>
            </div>

        </div>

        <script>
            async function loadProfile() {
                try {
                    // Fetch User Info
                    const userRes = await fetch('/api/auth/me');
                    if (userRes.ok) {
                        const user = await userRes.json();
                        document.getElementById('profile-username').textContent = user.username;
                        document.getElementById('profile-email').textContent = user.email;
                        // Date formatting could be better if backend returns it
                        // document.getElementById('profile-date').textContent = new Date(user.dateInscription).toLocaleDateString(); 
                    }

                    // Fetch My Annonces
                    const annoncesRes = await fetch('/api/annonces/me');
                    const container = document.getElementById('my-annonces-list');
                    container.innerHTML = '';

                    if (annoncesRes.ok) {
                        const annonces = await annoncesRes.json();

                        if (annonces.length === 0) {
                            container.innerHTML = `
                                <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: var(--text-muted);">
                                    <img src="/images/icons/box.svg" width="48" height="48" style="opacity: 0.3; margin-bottom: 1rem;"/>
                                    <p>Vous n'avez publiÃ© aucune annonce.</p>
                                    <a href="/annonces/new" class="btn btn-primary mt-1">Publier maintenant</a>
                                </div>
                            `;
                            return;
                        }

                        annonces.forEach(annonce => {
                            const card = document.createElement('div');
                            card.className = 'card fade-in-up';

                            // Image
                            let imgUrl = 'https://source.unsplash.com/random/400x300/?object';
                            if (annonce.images && annonce.images.length > 0) imgUrl = annonce.images[0];

                            card.innerHTML = `
                                <div style="height: 200px; overflow: hidden; border-radius: 12px; margin-bottom: 1rem; position: relative;">
                                    <img src="${imgUrl}" style="width: 100%; height: 100%; object-fit: cover;">
                                    <span class="badge" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white;">
                                        ${annonce.statut}
                                    </span>
                                </div>
                                <h3 style="margin-bottom: 0.5rem;">${annonce.titre}</h3>
                                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
                                    <img src="/images/icons/calendar.svg" width="14" height="14" style="vertical-align: middle;"/> ${new Date(annonce.datePublication).toLocaleDateString()}
                                </p>
                                
                                <div style="display: flex; gap: 0.5rem;">
                                    <a href="/annonces/${annonce.id}" class="btn btn-outline btn-sm" style="flex: 1; text-align: center;">Voir</a>
                                    <a href="/annonces/edit/${annonce.id}" class="btn btn-primary btn-sm" style="flex: 1; text-align: center; background: #fdcb6e; border-color: #fdcb6e;">
                                        <img src="/images/icons/edit.svg" width="14" height="14" style="filter: invert(1); vertical-align: middle;"/>
                                    </a>
                                    <button onclick="deleteAnnonce(${annonce.id})" class="btn btn-danger btn-sm" style="background: #ff7675; border-color: #ff7675; color: white;">
                                        <img src="/images/icons/trash.svg" width="14" height="14" style="filter: invert(1); vertical-align: middle;"/>
                                    </button>
                                </div>
                            `;
                            container.appendChild(card);
                        });
                    }

                } catch (e) {
                    console.error("Error loading profile", e);
                }
            }

            async function deleteAnnonce(id) {
                if (!confirm("ÃŠtes-vous sÃ»r de vouloir supprimer cette annonce ?")) return;

                try {
                    const res = await fetch(`/api/annonces/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        loadProfile(); // Reload list
                    } else {
                        alert("Erreur lors de la suppression");
                    }
                } catch (e) {
                    console.error(e);
                    alert("Erreur serveur");
                }
            }

            document.addEventListener('DOMContentLoaded', loadProfile);
        </script>
    </div>
</body>

</html>