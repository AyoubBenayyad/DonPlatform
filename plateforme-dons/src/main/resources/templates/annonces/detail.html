<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: main(~{::content})}">

<body>
    <div th:fragment="content">
        <div id="annonce-detail">
            <p>Chargement...</p>
        </div>

        <script>
            async function loadDetail() {
                const pathParts = window.location.pathname.split('/');
                const id = pathParts[pathParts.length - 1];

                try {
                    const response = await fetch(`/api/annonces/${id}`);
                    if (!response.ok) {
                        throw new Error('Not found');
                    }
                    const annonce = await response.json();

                    let imageUrl = 'https://source.unsplash.com/random/800x600/?object';
                    if (annonce.images && annonce.images.length > 0) {
                        imageUrl = annonce.images[0];
                    }

                    let currentUserId = null;
                    try {
                        const userRes = await fetch('/api/auth/me');
                        if (userRes.ok) {
                            const user = await userRes.json();
                            currentUserId = user.id;
                        }
                    } catch (e) {
                        // Utilisateur non connect√©
                    }

                    const isOwner = currentUserId && annonce.createur && (currentUserId === annonce.createur.id);

                    const editButtonHtml = isOwner ?
                        `<div style="margin-bottom: 1rem;">
                            <label style="font-weight:600; color:var(--text-color);">Statut :</label>
                            <select onchange="updateStatut(${annonce.id}, this.value)" class="form-control" style="width: 100%; margin-top: 0.5rem;">
                                <option value="DISPONIBLE" ${annonce.statut === 'DISPONIBLE' ? 'selected' : ''}>Disponible</option>
                                <option value="RESERVE" ${annonce.statut === 'RESERVE' ? 'selected' : ''}>R√©serv√©</option>
                                <option value="DONNE" ${annonce.statut === 'DONNE' ? 'selected' : ''}>Donn√©</option>
                            </select>
                         </div>
                         <a href="/annonces/edit/${annonce.id}" class="btn btn-primary" style="background: linear-gradient(45deg, #fdcb6e, #e17055); border:none; width: 100%; margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <img src="/images/icons/edit.svg" width="18" height="18" style="filter: invert(1); vertical-align: middle;" /> Modifier
                         </a>` : '';

                    const container = document.getElementById('annonce-detail');
                    if (!container) return;

                    container.innerHTML = `
                        <div class="fade-in-up">
                        <div style="margin-bottom: 2rem;">
                            <a href="/annonces" style="color: var(--text-muted); text-decoration: none; display: flex; align-items: center; gap: 0.5rem;">
                                <img src="/images/icons/search.svg" width="16" height="16" /> Retour aux annonces
                            </a>
                        </div>

                        <div class="card" style="overflow: hidden; padding: 0;">
                            <div style="height: 300px; background: #eee; position: relative;">
                                <img src="${imageUrl}" style="width: 100%; height: 100%; object-fit: cover;">
                                <div style="position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); padding: 2rem; box-sizing: border-box;">
                                    <h1 style="color: white; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">${annonce.titre}</h1>
                                    <div style="color: rgba(255,255,255,0.9); margin-top: 0.5rem; display: flex; gap: 1rem; align-items: center;">
                                        <span style="display: flex; align-items: center; gap: 0.4rem;"><img src="/images/icons/refresh.svg" width="16" height="16" style="filter: invert(1);" /> ${new Date(annonce.datePublication).toLocaleDateString()}</span>
                                        <span style="display: flex; align-items: center; gap: 0.4rem;"><img src="/images/icons/map-pin.svg" width="16" height="16" style="filter: invert(1);" /> ${annonce.zoneGeographique}</span>
                                        <span class="badge" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); color: white;">${annonce.statut}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="padding: 2rem;">
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 3rem;">
                                    <div>
                                        <h3 style="color: var(--primary-color);">Description</h3>
                                        <p style="font-size: 1.1rem; line-height: 1.8; color: var(--text-color);">${annonce.description}</p>
                                        
                                        <div style="margin-top: 2rem;">
                                            <h4 style="margin-bottom: 1rem;">Mots cl√©s</h4>
                                            <div>
                                                ${(annonce.motsCles || []).map(k => `<span class="badge" style="background: var(--bg-gradient); color: var(--text-color); margin-right: 0.5rem;">#${k}</span>`).join('')}
                                            </div>
                                        </div>
                                    </div>

                                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; height: fit-content;">
                                        <h4 style="margin-top: 0;">D√©tails</h4>
                                        <ul style="list-style: none; padding: 0; margin: 0;">
                                            <li style="margin-bottom: 1rem; display: flex; justify-content: space-between;">
                                                <span style="color: var(--text-muted);">√âtat</span>
                                                <strong>${annonce.etat}</strong>
                                            </li>
                                            <li style="margin-bottom: 1rem; display: flex; justify-content: space-between;">
                                                <span style="color: var(--text-muted);">Livraison</span>
                                                <strong>${annonce.modeRemise}</strong>
                                            </li>
                                            <li style="margin-bottom: 1rem; display: flex; justify-content: space-between;">
                                                <span style="color: var(--text-muted);">Donneur</span>
                                                <strong>${annonce.createur ? annonce.createur.username : 'Anonyme'}</strong>
                                            </li>
                                        </ul>

                                        <div style="margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem;">
                                            ${editButtonHtml}
                                            <div id="contact-info-area" style="display:none; text-align: center; margin-bottom: 1rem; padding: 1rem; background: #e3f2fd; border-radius: 8px;">
                                                <p style="margin:0; font-weight:600;">üìß ${annonce.createur.email}</p>
                                            </div>
                                            <button id="contact-btn" onclick="toggleContact(${annonce.createur.id})" class="btn btn-primary" style="width: 100%; text-align: center; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                                <img src="/images/icons/message.svg" width="18" height="18" style="filter: invert(1);" /> Contacter
                                            </button>
                                            <button onclick="addFavori(${annonce.id})" class="btn btn-outline" style="width: 100%; text-align: center; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                                <img src="/images/icons/heart.svg" width="18" height="18" /> Favoris
                                            </button>
                                        </div>
                                        <div id="actionFeedback" style="display:none; margin-top: 1rem; padding: 0.5rem; border-radius: 8px; font-size: 0.9rem; text-align: center;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                        `;

                } catch (error) {
                    document.getElementById('annonce-detail').innerHTML = `
                        <div class="card" style="text-align: center; padding: 4rem;">
                            <h2>Annonce introuvable</h2>
                            <p>Cette annonce n'existe pas ou a √©t√© supprim√©e.</p>
                            <a href="/annonces" class="btn btn-primary">Retour aux annonces</a>
                        </div>
                        `;
                }
            }

            function showFeedback(msg, isError = false) {
                const el = document.getElementById('actionFeedback');
                if (el) {
                    el.style.display = 'block';
                    el.textContent = msg;
                    el.style.background = isError ? '#ffebee' : '#e8f5e9';
                    el.style.color = isError ? '#c62828' : '#2e7d32';
                    setTimeout(() => el.style.display = 'none', 3000);
                }
            }

            async function addFavori(id) {
                try {
                    const res = await fetch(`/api/favorites/toggle/${id}`, {
                        method: 'POST'
                    });
                    if (res.ok) showFeedback('Ajout√© aux favoris !');
                    else if (res.status === 401 || res.status === 403) {
                        window.location.href = '/login';
                    } else {
                        const errorText = await res.text();
                        console.error("‚ùå [Frontend] Error adding favorite:", res.status, errorText);
                        showFeedback('Erreur lors de l\'ajout', true);
                    }
                } catch (e) {
                    console.error("‚ùå [Frontend] Server error adding favorite:", e);
                    showFeedback('Erreur serveur', true);
                }
            }

            async function updateStatut(id, newStatut) {
                try {
                    const res = await fetch(`/api/annonces/${id}/statut?statut=${newStatut}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' } // Not strictly needed for params but good practice
                    });
                    if (res.ok) {
                        showFeedback('Statut mis √† jour !');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showFeedback('Erreur mise √† jour', true);
                    }
                } catch (e) {
                    console.error(e);
                    showFeedback('Erreur serveur', true);
                }
            }

            function toggleContact(userId) {
                const area = document.getElementById('contact-info-area');
                const btn = document.getElementById('contact-btn');
                if (area.style.display === 'none') {
                    area.style.display = 'block';
                    btn.innerHTML = '<img src="/images/icons/message.svg" width="18" height="18" style="filter: invert(1);" /> Masquer Contact';
                } else {
                    area.style.display = 'none';
                    btn.innerHTML = '<img src="/images/icons/message.svg" width="18" height="18" style="filter: invert(1);" /> Contacter';
                }
            }

            // Execute
            loadDetail();
        </script>
    </div>
</body>

</html>